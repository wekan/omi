# Server Setup Guide

> **Documentation Index:** See [README.md](README.md) for documentation overview  
> **Quick Start:** See [README.md](README.md#server-deployment)

## Overview

This guide covers setting up Omi on a web server. The included PHP application supports multiple web servers with pretty URL routing.

## Pretty URLs

The server supports pretty URLs for browsing repositories:

- `/` - List all repositories
- `/wekan` - Browse wekan.omi repository root
- `/wekan/src` - Browse src directory in wekan.omi
- `/wekan/README.md` - View README.md file content
- `/reponame/path/to/file.txt` - View specific file

## Server Configuration

Choose one of the following web servers based on your preference:

### Caddy (Recommended - simplest)

**Installation:**
```bash
# Download from https://caddyserver.com/download
# Or install via package manager:
sudo apt install caddy          # Debian/Ubuntu
brew install caddy              # macOS
```

**Configuration:**
```bash
# Place Caddyfile in your project directory
# (Provided in docs/webserver/Caddyfile)

# Start Caddy
caddy run

# Or as background service
caddy start
```

**Features:**
- HTTPS with automatic certificate generation
- Simple configuration syntax
- Minimal dependencies
- Good for small deployments

### Apache

**Prerequisites:**
- Apache 2.2+
- mod_rewrite enabled
- PHP 5.3+ with Apache module or PHP-FPM

**Installation:**
```bash
# Enable mod_rewrite
sudo a2enmod rewrite

# Copy configuration to sites-available
sudo cp docs/webserver/apache.conf /etc/apache2/sites-available/omi.conf

# Create symbolic link
sudo a2ensite omi.conf

# Test configuration
sudo apache2ctl configtest

# Reload Apache
sudo systemctl reload apache2
```

**Alternative - .htaccess:**
```bash
# Copy .htaccess (if provided with webserver configs)
# Required for per-directory rewrite rules
```

**Configuration Details:**
- Uses mod_rewrite for pretty URLs
- DocumentRoot points to public/ directory
- Handles index.php routing

### Nginx

**Prerequisites:**
- Nginx 1.0+
- PHP-FPM
- PHP 5.3+

**Installation:**
```bash
# Copy nginx configuration to sites-available
sudo cp docs/webserver/nginx.conf /etc/nginx/sites-available/omi

# Create symbolic link
sudo ln -s /etc/nginx/sites-available/omi /etc/nginx/sites-enabled/

# Test configuration
sudo nginx -t

# Reload Nginx
sudo systemctl reload nginx
```

**Configuration Details:**
- Uses try_files for pretty URL routing
- FastCGI upstream to PHP-FPM
- All requests go through index.php

**Note:** Nginx does not support .htaccess files. Configuration must be in server block.

## Configuration Files

### settings.txt

Located in project root. Controls server behavior:

```cfg
SQLITE=/usr/bin/sqlite3
USERNAME=admin
PASSWORD=password
REPOS=http://localhost/
CURL=/usr/bin/curl
API_ENABLED=1
API_RATE_LIMIT=60
API_RATE_LIMIT_WINDOW=60
```

**Parameters:**
- **SQLITE** - Path to sqlite3 executable
- **USERNAME** - Default username for CLI
- **PASSWORD** - Default password for CLI
- **REPOS** - Server root URL (used by CLI)
- **CURL** - Path to curl executable
- **API_ENABLED** - Enable/disable API (1 or 0)
- **API_RATE_LIMIT** - Max requests per window
- **API_RATE_LIMIT_WINDOW** - Time window in seconds

**Editing via Web:**
1. Log in to `/settings`
2. Update configuration
3. Click "Save Settings"
4. Changes written to settings.txt

### phpusers.txt

User credentials file. Format: `username:password:otpauth_url`

**Manual format:**
```
admin:password123:otpauth://totp/Omi/admin?secret=BASE32SECRET&issuer=Omi
user1:password456:otpauth://totp/Omi/user1?secret=BASE32SECRET&issuer=Omi
```

**Creating via Web:**
1. Go to `/people`
2. Click "Add New User"
3. Enter username and password
4. Click "Add User"

**2FA Setup:**
- Users can enable TOTP in their 2FA settings
- otpauth:// URL generated by authentication system
- RFC 6238 compatible

### Other Files

- **phpusersbruteforcelocked.txt** - Locked accounts (one per line)
- **phpusersfailedattempts.txt** - Failed login tracking
- **api_rate_limit.txt** - API request tracking per user

## Web Server Configurations

Configuration templates are provided in `docs/webserver/` directory:

| File | Web Server | Best For |
|------|-----------|----------|
| Caddyfile | Caddy | New deployments, small/medium sites |
| apache.conf | Apache | Existing Apache deployments |
| nginx.conf | Nginx | High-performance deployments, reverse proxy |

**Using the templates:**
1. Copy template to web server config directory
2. Edit paths to match your installation
3. Update server name/SSL certificates
4. Reload web server

## HTML 3.2 Compatibility

The web interface uses HTML 3.2 with no JavaScript or CSS for compatibility with retro browsers:

**Test Environment:**
- **IBrowse with AmiSSL** - Commodore Amiga (full support)
- **Dillo** - FreeDOS/old Linux (full support)
- **Elinks** - Linux text mode (full support)
- **w3m** - Linux text mode (full support)

**Layout:**
- Table-based (no CSS)
- Simple form inputs (no JavaScript)
- Compatible with Lynx and other text browsers

## Features

✅ Pretty URLs (no query strings)
✅ Repository browsing (like GitHub/Fossil)
✅ Directory navigation
✅ Text file viewing and editing
✅ Binary file detection
✅ Image viewing
✅ User management
✅ Settings configuration
✅ HTML 3.2 compatible
✅ Works with old browsers
✅ API with 2FA support
✅ API rate limiting

## Security Considerations

### HTTPS
- Required in production
- Caddy: Automatic via Let's Encrypt
- Apache: Configure SSL certificates
- Nginx: Configure SSL certificates

### File Permissions
- Web server must read `settings.txt`, `phpusers.txt`
- Web server must write to `api_rate_limit.txt`
- Repository files in `repos/` must be readable

```bash
# Example permissions
chmod 644 settings.txt phpusers.txt
chmod 755 repos/
```

### Credentials
- Change default credentials in `settings.txt`
- Use strong passwords (15+ chars recommended)
- Enable 2FA for important accounts

### Access Control
- Only authenticated users can edit files
- Settings page requires login
- User management requires login

## Deployment Checklist

- [ ] Choose web server (Caddy/Apache/Nginx)
- [ ] Install web server and PHP
- [ ] Copy `public/index.php` to web root
- [ ] Create/configure `settings.txt`
- [ ] Create `phpusers.txt` with admin account
- [ ] Set file permissions correctly
- [ ] Configure web server routing
- [ ] Test URLs: `/`, `/login`, `/logout`
- [ ] Create test repository
- [ ] Test file editing
- [ ] Enable HTTPS/SSL
- [ ] Configure firewalls

## Troubleshooting

### Pretty URLs Not Working
- Check mod_rewrite is enabled (Apache)
- Check nginx try_files configuration
- Verify DocumentRoot points to correct directory
- Test with `http://server/notafile.php` (should 404)

### PHP Errors
- Check PHP error logs
- Ensure PHP 5.3+ installed
- Check PHP extensions: sqlite3, curl

### File Permissions
- Web server can't write to settings.txt
- Solution: `chmod 644 settings.txt`
- Ensure directory is writable for rate limiting

### Database Errors
- sqlite3 command not found
- Solution: Install sqlite3, update settings.txt SQLITE path
- Cannot create .omi files
- Solution: Check write permissions to repos/

### Users Not Appearing
- Check phpusers.txt file exists
- Verify format: `username:password`
- Reload web page (may be cached)

### Settings Not Saving
- Check write permission to settings.txt
- Check web server error logs
- Try again after granting permissions

## Performance Tips

- Cache index page (5-minute TTL)
- Use Nginx for high traffic (better performance)
- Compress text responses with gzip
- Consider CDN for static assets
- Monitor API rate limiting (may need adjustment)

## Monitoring

**Log Files to Check:**
- Web server error log (Apache/Nginx)
- PHP error log
- System log for permission issues

**Useful Commands:**
```bash
# Check web server status
systemctl status caddy
systemctl status apache2
systemctl status nginx

# Check PHP-FPM (Nginx only)
systemctl status php-fpm

# View recent API rate limits
tail -f api_rate_limit.txt

# Check file permissions
ls -la settings.txt phpusers.txt repos/
```

---

## See Also

- **[README.md](README.md)** - Documentation index
- **[WEB.md](WEB.md)** - Web interface guide
- **[FEATURES.md](FEATURES.md)** - Feature overview
- **[CLI_BASH.md](CLI_BASH.md)** - CLI usage
- **[DATABASE_SCHEMA.md](DATABASE_SCHEMA.md)** - Database design

## Web Server Configurations

Configuration files in `docs/webserver/` directory:
- **Caddyfile** - Caddy configuration (recommended)
- **apache.conf** - Apache configuration
- **nginx.conf** - Nginx configuration
