# Nginx configuration for Omi Server
# Include this in your main nginx.conf or sites-available/

server {
    listen 80;
    # listen 443 ssl http2;
    
    server_name omi.wekan.fi;
    root /home/wekan/repos/wekan/public;
    index index.php;
    
    # SSL configuration (uncomment for HTTPS)
    # ssl_certificate /etc/letsencrypt/live/omi.wekan.fi/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/omi.wekan.fi/privkey.pem;
    
    # Security: Don't allow direct access to repos directory
    location /repos/ {
        deny all;
        return 403;
    }
    
    # Security: Protect settings.txt
    location ~ /settings.txt {
        deny all;
        return 403;
    }
    
    # Security: Deny access to hidden files
    location ~ /\. {
        deny all;
        return 403;
    }
    
    # Handle .omi file downloads via query string
    location ~ ^/ {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    # PHP handler
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.2-fpm.sock;  # Adjust PHP version as needed
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
    
    # Enable gzip compression
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    
    # Client upload size limit
    client_max_body_size 100M;
    
    # Logging
    access_log /var/log/nginx/omi_access.log;
    error_log /var/log/nginx/omi_error.log;
}
