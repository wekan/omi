# Apache VirtualHost configuration for Omi Server
# Place in /etc/apache2/sites-available/ and enable with: a2ensite omi.conf

<VirtualHost *:80>
    ServerName omi.wekan.fi
    ServerAdmin admin@wekan.fi
    
    DocumentRoot /home/wekan/repos/wekan/public
    
    <Directory /home/wekan/repos/wekan/public>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Enable .htaccess
        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
            
            # Don't rewrite for actual files and directories
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            
            # Don't allow direct access to repos directory
            RewriteRule ^repos/ - [F,L]
            
            # Don't rewrite for .omi files in download mode
            RewriteCond %{QUERY_STRING} download=
            RewriteRule .* - [L]
            
            # Rewrite everything else to index.php
            RewriteRule ^(.*)$ index.php [QSA,L]
        </IfModule>
    </Directory>
    
    # Deny access to repos directory
    <Directory /home/wekan/repos/wekan/repos>
        Require all denied
    </Directory>
    
    # Deny access to settings.txt
    <Files "settings.txt">
        Require all denied
    </Files>
    
    # Deny access to hidden files
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    
    # PHP settings
    <IfModule mod_php.c>
        php_value upload_max_filesize 100M
        php_value post_max_size 100M
        php_value max_execution_time 300
    </IfModule>
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/omi_error.log
    CustomLog ${APACHE_LOG_DIR}/omi_access.log combined
</VirtualHost>

# HTTPS VirtualHost (uncomment and configure for SSL)
# <VirtualHost *:443>
#     ServerName omi.wekan.fi
#     ServerAdmin admin@wekan.fi
#     
#     DocumentRoot /home/wekan/repos/wekan/public
#     
#     SSLEngine on
#     SSLCertificateFile /etc/letsencrypt/live/omi.wekan.fi/fullchain.pem
#     SSLCertificateKeyFile /etc/letsencrypt/live/omi.wekan.fi/privkey.pem
#     
#     <Directory /home/wekan/repos/wekan/public>
#         Options -Indexes +FollowSymLinks
#         AllowOverride All
#         Require all granted
#     </Directory>
#     
#     # Same directory and file restrictions as HTTP
#     <Directory /home/wekan/repos/wekan/repos>
#         Require all denied
#     </Directory>
#     
#     <Files "settings.txt">
#         Require all denied
#     </Files>
#     
#     ErrorLog ${APACHE_LOG_DIR}/omi_ssl_error.log
#     CustomLog ${APACHE_LOG_DIR}/omi_ssl_access.log combined
# </VirtualHost>
